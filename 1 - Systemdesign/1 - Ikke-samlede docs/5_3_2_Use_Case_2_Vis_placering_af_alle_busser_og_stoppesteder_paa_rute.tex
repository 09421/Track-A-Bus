\documentclass[Main.tex]{subfiles} 
\begin{document}

\subsubsection{Use Case 2: Vis placering af alle busser og stoppesteder på valgt rute}
Denne Use Case kan startes efter Use Case 1 eller 4 er gennemført. Den startes ved et tryk på en rute, enten fra hovedskærmen eller fra listen af alle busruter. Hovedforløbet splitter sig altså op, alt efter hvordan Use Case 2 startes. I OnCreate, hvis det medsendte intent ikke har et favoriserings flag med, sættes der ikke en progressbar. Dette gøres, fordi busruten læses så hurtigt ind, at det ikke vil have nogen effekt. Herudover opsættes viewet, og der vælges om der skal læses fra SQLite- eller MySQL databasen. Rutenummeret, medsendt i det intent activityet er startet med, sættes i informations baren, over kortet. Desuden opsættes kortet med det samme, hvis det er en favoriset rute. I OnStart startes servicen, og når forbindelsen er oprettet, startes tegningen af ruten baseret på det valg af database, der blev sat i OnCreate.
\begin{itemize}
	\item \textbf{Favorit rute}
	\begin{itemize}
		\item Samtlige rute IDer hentes fra SQLite databasen. Dette gøres da det er muligt at ruten er kompleks, og bliver gemt som seperate subruter. Herefter bliver hver subrutes stoppesteder og rutepunkter hentet, igen fra SQLite databasen, og disse tegnes på kortet. Hentningen sker i en seperat tråd, men rutepunkter og stoppesteder skal sættes i main-tråden, da viewet skal opdateres, og det kun kan gøres fra den tråd der oprettede viewet. 
	\end{itemize}
	\item \textbf{Ikke favoriset rute}
	\begin{itemize}
		\item Servicen kaldes og den sørger for at hente busruten og stoppesteder fra MySQL databasen. Ruten kan være kompleks, og derfor hentes samtlige ruter og stoppesteder, med det valgte rutenummer. Til hvert stoppested og busrute er der oprettet en speciel designet model klasse, som implementerer parcelable. Denne funktionalitet beskrives i \textit{8.2.1: Komponent 1: Mobil applikation}. Servicen henter det hele i en seperat tråd. \\
		Servicen sætter hentede busruter og stoppesteder i en message, og sender den til den medsendte  MessageHandler. I BusMapActivity håndteres denne besked i main-tråden. Progressbaren færdiggøres, kortet opsættes, og hentede ruter og stoppesteder hentes og tegnes.
	\end{itemize}
\end{itemize}
Ruten består kun af de punkter, som ikke er stoppesteder. Stoppestederne kan ligge forskudt for ruten, hvilket ville gøre, at ruten ikke vil følge vejene. Ruten bliver indtegnet som en rød polyline, og stoppestederne bliver indtegnet som et punkt med custom markers. \\

\noindent
Samtidig med ruten hentes og tegnes, startes processen, hvor positionen for busserne hentes. Dette gøres ved et kald til servicen, hvor en messagehandler sendes med. Hentningen sker i seperat tråd, og kører så længe servicen er bundet til viewet. Samtlige hentede positioner sendes tilbage over den medsendte messagehandler, og markerne for bussernes fjernes, hvis de i forvejen er sat, og sættes igen med deres nye position. Når viewet lukkes, unbindes servicen og positionen for busserne holdes ikke længere opdateret. På figur \ref{fig:UC2SSD}, kan et simpelt sekvensdiagram ses, for processen omhandlende tegning af favorit rute, stoppesteder og bus positioner. Samme sekvensdiagram kan bruges for tegning af en ikke favoriseret rute med stoppested, hvor aktiviteten starter fra BusListMenuActivity, og TrackABusProvider tilgås i stedet for ContentProviderAcces, for at hente ruten. 

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.65]{Diagrammer/Sekvensdiagrammer/UC2SSD}
	\caption{Sekvensdiagram for tegning af en favoriseret rute, og hentning af bus positioner}
	\label{fig:UC2SSD}
\end{figure}



\end{document}