\documentclass[Main.tex]{subfiles} 
\begin{document}

\subsection{Implementering af persistens}
Persisteringen af data består af to hoveddele. En facade til den direkte tilgang og en besked kø der lavet efter observer design mønsteret som bliver beskrevet i implementeringsviewet, afsnit 8.2.7-Observer Pattern
\\
For at tilgå databasen på C\# siden er der blevet brugt facade designmønsteret. Tilgangen til databasen sker altså igennem én klasse, så vi bevarer lav kobling. Til selve forbindelsen blev der brugt SQLCommands. Dette er en del af .Net frameworket. Forbindelsen ligger hardcodet i facaden, dvs. at det ikke er op til brugeren af systemet, at definere hvilken database man tilgår. Denne forbindelse består af en streng med bruger id, password, server, database og diverse optionelle valgmuligheder som f.eks. Connection Timeout som i dette tilfælde bestemmer, hvor lang tid systemet maksimalt må bruge på at skabe forbindelse. På kodeudsnit \ref{lst:SqlconnectionCode} kan man se hvordan forbindelsen bliver defineret og oprettet.
\begin{lstlisting}[caption=Definition and opening of connection to database, label={lst:SqlconnectionCode}]
private const string UserID     = "user id=F12I4PRJ4Gr5;";
private const string Password   = "password=F12I4PRJ4Gr5;";
private const string Server     = "server=webhotel10.iha.dk;"; 
private const string Database   = "database=F12I4PRJ4Gr5; ";
private const string ConnectionTimeOut = "Connection TimeOut=2";

private readonly SqlConnection _myConnection = new SqlConnection(
                                        UserID +
                                        Password +
                                        Server +
                                        Database +
                                        ConnectionTimeOut
                                        );
..............

if (_myConnection.State != ConnectionState.Open)
        _myConnection.Open();
\end{lstlisting}
Forbindelsen bliver brugt ved at eksekvere en SQL streng fra C\# siden, altså en SQL statement skrevet i en string. Det er blevet forsøgt at gøre disse commands generelle, så alt efter hvad man vil på en vilkårlig tabel, kan man tilgå en generel funktion, som specificeres via parametre. Når en funktion, der henter noget fra databasen køres, vil data returneres via en SQLDatareader som funktionen, ExecuteReader(), returnerer. Nedunder, på kodeudsnit \ref{lst:SqlcommandCode} kan man se, hvordan en simpel SELECT statement bliver brugt, kørt og hvordan den returnerer data.

\begin{lstlisting}[caption= Definition of a Select statement with a where clause, label={lst:SqlcommandCode}]
public List<string> SelectFrom(string columnName, 
						                   string tableName,
							   	             string whereColumnName,
							                 string target)
{		
      if (_myConnection.State != ConnectionState.Open)
                _myConnection.Open();
                
      var back = new List<string>();
      var command = new SqlCommand(string.Format(
      			          "SELECT {0} FROM {1} WHERE {2}='{3}'",
      		              columnName, tableName,
      		              whereColumnName, 
      		              target), 
      		              _myConnection);
      		              
      var read = command.ExecuteReader();
      while (read.Read())
      {
            back.Add(read[columnName].ToString().TrimEnd(' '));
                
      }
      read.Close();
      _myConnection.Close();
      return back;
}
\end{lstlisting}
\noindent
Når man kalder Execute reader bliver den specificerede streng kørt på databasen. Hvis operationen på databasen returnerer noget vil dette blive hentet via read[columnName] hvor columnName er den kolonne man vil hente fra. Hvis der hentes flere kolonne fra databasen vil disse blive gemt i den kolonne man specificerer. Database tilgangen sker på samme måde ved samtlige funktioner, med den undtagelse, at der ikke returneres noget på de operationer på databasen, der ikke skal returnere noget f.eks. insert- eller update statements. Disse operationer er de eneste der forekommer på databasen, udover de triggers og functions der også kan køres.

\end{document}